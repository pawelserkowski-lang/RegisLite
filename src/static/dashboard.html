<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="utf-8">
    <title>RegisLite 6.0 - OmniTool (CyberDeck)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark-reasonable.min.css"> <!-- Used a darker theme to fit -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cyber-black': '#000000',
                        'cyber-green': '#00FF41',
                        'cyber-dim': '#003B00',
                        'cyber-alert': '#FF0000',
                        'cyber-amber': '#FFB000',
                    },
                    fontFamily: {
                        mono: ['"Courier New"', 'Courier', 'monospace'],
                    },
                    borderRadius: {
                        DEFAULT: '0px',
                        'none': '0px',
                        'sm': '0px',
                        'md': '0px',
                        'lg': '0px',
                        'xl': '0px',
                        '2xl': '0px',
                        'full': '0px',
                    },
                    cursor: {
                        'block': 'block', // Custom cursor if needed, but text-cursor is standard
                    }
                }
            }
        }
    </script>
    
    <style>
        /* GLOBAL RESET & BASICS */
        body {
            background-color: #000000;
            color: #00FF41;
            font-family: 'Courier New', Courier, monospace;
            overflow-x: hidden;
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #000000; border-left: 1px solid #003B00; }
        ::-webkit-scrollbar-thumb { background: #003B00; border: 1px solid #00FF41; }
        ::-webkit-scrollbar-thumb:hover { background: #00FF41; }

        /* SCANLINES OVERLAY */
        .scanlines {
            background: linear-gradient(
                to bottom,
                rgba(255,255,255,0),
                rgba(255,255,255,0) 50%,
                rgba(0,0,0,0.2) 50%,
                rgba(0,0,0,0.2)
            );
            background-size: 100% 4px;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 9999;
            pointer-events: none;
        }

        /* TEXT GLOW */
        .text-glow {
            text-shadow: 0 0 5px #00FF41, 0 0 10px #00FF41;
        }

        /* UTILS */
        .cyber-border {
            border: 1px solid #00FF41;
        }
        .cyber-border-dim {
            border: 1px solid #003B00;
        }
        
        /* INPUT CARET */
        input, textarea {
            caret-color: #00FF41;
            caret-shape: block; /* Experimental */
        }
        
        /* MARKDOWN OVERRIDES FOR CYBER THEME */
        .prose pre {
            background-color: #000000 !important;
            border: 1px solid #003B00;
            border-radius: 0 !important;
        }
        .prose code {
            font-family: 'Courier New', monospace !important;
            color: #00FF41 !important;
        }
        .prose p, .prose li {
            color: #00FF41;
        }
        .prose strong {
            color: #00FF41;
            text-shadow: 0 0 2px #00FF41;
        }

        /* HLJS Overrides */
        .hljs {
            background: #000000 !important;
            color: #00FF41 !important;
        }
    </style>
</head>
<body class="antialiased min-h-screen relative p-4 selection:bg-cyber-green selection:text-cyber-black">

<div class="scanlines"></div>

<div class="max-w-6xl mx-auto space-y-6 relative z-10">

    <!-- HEADER PANEL -->
    <div class="cyber-border p-4 bg-cyber-black">
        <h1 class="text-2xl uppercase tracking-widest text-glow font-bold mb-4">
            ðŸ¤– RegisLite 6.0 <span class="text-xs text-cyber-dim align-middle">| OmniTool System</span>
        </h1>
        
        <div class="flex flex-wrap gap-4 items-end">
            <div class="flex-grow max-w-md">
                <label class="block text-xs text-cyber-green mb-1 uppercase">Target File</label>
                <input type="file" id="zip" accept=".zip"
                       class="block w-full text-sm text-cyber-green
                              file:mr-4 file:py-2 file:px-4
                              file:border file:border-cyber-green
                              file:text-cyber-green file:bg-black
                              file:cursor-pointer hover:file:bg-cyber-green hover:file:text-black
                              cursor-pointer border-b border-cyber-dim focus:border-cyber-green focus:outline-none bg-transparent p-2">
            </div>

            <button onclick="upload()"
                    class="h-10 px-6 border border-cyber-green text-cyber-green uppercase text-sm tracking-wider
                           hover:bg-cyber-green hover:text-black transition-none focus:outline-none active:translate-y-px">
                Upload ZIP
            </button>

            <button onclick="debug()" id="btn-debug" disabled
                    class="h-10 px-6 border border-cyber-dim text-cyber-dim uppercase text-sm tracking-wider
                           cursor-not-allowed disabled:opacity-50">
                ðŸ”§ Auto-Fix
            </button>
        </div>
    </div>

    <!-- MAIN TERMINAL PANEL -->
    <div class="cyber-border bg-cyber-black flex flex-col h-[800px]">
        <!-- Panel Header -->
        <div class="bg-cyber-green text-black px-4 py-1 text-sm font-bold uppercase flex justify-between items-center">
            <span>Terminal & Chat // Memory Enabled</span>
            <span class="text-[10px]">Markdown Supported</span>
        </div>

        <!-- Meta Bar -->
        <div class="p-2 border-b border-cyber-dim flex gap-4 text-xs font-mono">
            <div class="flex items-center gap-2">
                <span class="text-cyber-dim">STATUS:</span>
                <span id="status-text" class="text-cyber-green text-glow">READY</span>
            </div>
            <div id="badge-model-container" class="hidden">
                 <span class="text-cyber-dim">MODEL:</span>
                 <span id="badge-model" class="text-cyber-amber"></span>
            </div>
            <div id="badge-time-container" class="hidden">
                 <span class="text-cyber-dim">LATENCY:</span>
                 <span id="badge-time" class="text-cyber-green"></span>
            </div>
        </div>

        <!-- Progress Bar -->
        <div id="p-container" class="px-4 py-2 opacity-0 transition-opacity duration-300">
             <div class="w-full border border-cyber-dim h-4 p-0.5">
                 <div id="p-bar" class="h-full bg-cyber-green w-0 transition-all duration-300 ease-out shadow-[0_0_10px_#00FF41]"></div>
             </div>
        </div>
        
        <!-- Output Area -->
        <div id="term-output" class="flex-grow overflow-y-auto p-4 font-mono text-sm space-y-4">
            <div class="text-cyber-dim italic">> System gotowy. Wgraj projekt, aby rozpoczÄ…Ä‡.</div>
        </div>

        <!-- Command Input -->
        <div class="p-4 border-t border-cyber-green bg-black">
            <div class="flex items-center gap-2">
                <span class="text-cyber-green animate-pulse">></span>
                <input type="text" id="cmd"
                       placeholder="Wpisz komendÄ™ lub zapytaj AI..."
                       autocomplete="off"
                       class="w-full bg-transparent border-none focus:ring-0 text-cyber-green placeholder-cyber-dim font-mono focus:outline-none">
            </div>
        </div>
    </div>
</div>

<script>
let sid = null;
let ws = null;

// Konfiguracja marked.js
marked.setOptions({
    highlight: function(code, lang) {
        if (lang && hljs.getLanguage(lang)) {
            return hljs.highlight(code, { language: lang }).value;
        }
        return hljs.highlightAuto(code).value;
    }
});

function log(text, type='result') {
    const out = document.getElementById('term-output');
    const div = document.createElement('div');
    
    // Add border-l or visual distinction based on type
    if (type === 'user') {
        div.className = 'border-l-2 border-cyber-green pl-2 text-white font-bold mb-2';
        div.innerText = `> ${text}`;
    } else if (type === 'progress') {
        div.className = 'text-cyber-dim italic text-xs mb-2';
        div.innerText = `>> ${text}`;
    } else if (type === 'error') {
        div.className = 'border-l-2 border-cyber-alert pl-2 text-cyber-alert mb-2';
        div.innerText = `[ERROR] ${text}`;
    } else {
        // Result (Markdown)
        div.className = 'prose max-w-none text-cyber-green mb-4 pb-4 border-b border-cyber-dim last:border-0';
        div.innerHTML = marked.parse(text);
    }
    
    out.appendChild(div);
    out.scrollTop = out.scrollHeight;
}

function updateProgress(percent, text) {
    const cont = document.getElementById('p-container');
    const bar = document.getElementById('p-bar');
    const stat = document.getElementById('status-text');
    
    if (percent > 0) {
        cont.style.opacity = 1;
        bar.style.width = percent + '%';
        stat.textContent = text.toUpperCase();
        stat.classList.add('animate-pulse');
    } else {
        cont.style.opacity = 0;
        bar.style.width = '0%';
        if (text) stat.textContent = text.toUpperCase();
        stat.classList.remove('animate-pulse');
    }
}

function setMeta(model, time) {
    const bmCont = document.getElementById('badge-model-container');
    const bm = document.getElementById('badge-model');
    const btCont = document.getElementById('badge-time-container');
    const bt = document.getElementById('badge-time');
    
    if (model && model !== '-') {
        bm.textContent = model;
        bmCont.classList.remove('hidden');
        bmCont.classList.add('flex', 'items-center', 'gap-2');
    }
    if (time) {
        bt.textContent = time;
        btCont.classList.remove('hidden');
        btCont.classList.add('flex', 'items-center', 'gap-2');
    }
}

async function upload() {
    const file = document.getElementById('zip').files[0];
    if (!file) return alert("Wybierz plik!");
    
    updateProgress(30, "WysyÅ‚anie...");
    const form = new FormData(); form.append("file", file);
    
    try {
        const res = await fetch("/upload", { method: "POST", body: form });
        const data = await res.json();
        if(!res.ok) throw new Error(data.detail);
        
        sid = data.session_id;
        log(`Sesja utworzona: ${sid}`, 'progress');

        // Enable Debug Button
        const btn = document.getElementById('btn-debug');
        btn.disabled = false;
        btn.classList.remove('border-cyber-dim', 'text-cyber-dim', 'cursor-not-allowed');
        btn.classList.add('border-cyber-green', 'text-cyber-green', 'hover:bg-cyber-green', 'hover:text-black');

        initWS();
        updateProgress(0, "Ready");
    } catch(e) {
        log(e.message, 'error');
        updateProgress(0, "BÅ‚Ä…d");
    }
}

async function debug() {
    if (!ws) return alert("Brak poÅ‚Ä…czenia!");
    const cmd = "PrzeprowadÅº peÅ‚nÄ… analizÄ™ i naprawÄ™ projektu.";
    log("Uruchamiam Auto-Fixer...", 'user');
    ws.send(cmd);
    updateProgress(20, "Autonaprawa...");
}

function initWS() {
    ws = new WebSocket(`ws://${location.host}/ws/${sid}`);
    ws.onmessage = (e) => {
        try {
            const msg = JSON.parse(e.data);
            
            if (msg.type === 'progress') {
                updateProgress(60, msg.content);
            } else if (msg.type === 'result') {
                updateProgress(0, "Ready");
                log(msg.content, 'result');
                if (msg.meta) setMeta(msg.meta.model, msg.meta.duration);
            } else if (msg.type === 'error') {
                updateProgress(0, "Error");
                log(msg.content, 'error');
            }
        } catch {
            log(e.data, 'result');
        }
    };
    ws.onclose = () => {
        updateProgress(0, "RozÅ‚Ä…czono");
        log("PoÅ‚Ä…czenie z serwerem przerwane.", 'error');
    };
}

document.getElementById('cmd').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        const val = e.target.value;
        if (!val) return;
        if (!ws) return alert("Najpierw wgraj projekt!");
        
        log(val, 'user');
        ws.send(val);
        e.target.value = '';
        updateProgress(20, "WysÅ‚ano...");
    }
});
</script>
</body>
</html>
